# 5. TON Payments

我们将在本文中简要讨论的 TON 项目的最后一个组成部分 —— TON Payments，这是（微）支付通道和“闪电网络”组成的价值转移平台。 它将实现“即时”支付，而无需将所有交易提交到区块链中，也无需支付相关的交易费用（例如，消耗的燃料费），并且不用等待五秒钟确认新区块包含有关交易。

由于这种即时支付的总体开销很小，所以人们将它们用于小额支付。 例如，TON 文件存储服务可能会要求每 128K 下载数据支付小额费用，又或者使用付费 TON Proxy 可能需要为每中继128 KiB 流量提供一些小额微支付。

虽然 TON Payments 可能会晚于 TON 项目的核心组件发布，但在一开始就需要考虑一些因素。 例如，用于执行 TON 区块链智能合约代码的 TON 虚拟机（TON VM; 参见 2.1.20）必须支持 Merkle 证明的一些特殊操作。 如果原始设计中没有此类支持，则在稍后添加它可能会成为问题（参见 2.8.16）。 但是，我们将看到 TON VM 原生支持“智能”支付通道（参见 5.1.9）。

### 5.1 支付通道

我们首先讨论点对点支付通道，以及如何在 TON 区块链中实现它们。

### 5.1.1 支付通道的构思

假设 A 和 B 两方都知道他们将来需要相互支付很多款项。他们不是将每笔付款作为区块链中的交易，而是创建一个共享的“资金池”（或者是一个只有两个帐户的小型私人银行），并为其提供一些资金：A 存放 a 个币，B 存放 b 个币。 这是通过在区块链中创建一个特殊的智能合约并将代币汇给它来实现的。

在创建“资金池”之前，双方都要同意某个协议。 他们将跟踪"资金池"的*状态* - 即共享池中的余额。 最初，状态是 *(a, b)*，意思是 a 个币属于A，b 个币属于 B。然后，如果 A 想要向 B 支付代币，他们可以简单地同意新状态是 *(a', b') = (a - d, b + d)*。

之后，如果 B 想要向 A 支付代币，则状态将变为 *(a'', b'') = (a' + d', b' - d')*，依此类推。

所有池内的这些余额更新完全都是链下的。 当双方决定从池中取出自己的资金时，他们会根据资金池的最终状态进行提取。 这实际上是通过向智能合约发送特殊消息来实现的，消息中包含商定的最终状态 (a\*, b\*) 以及 A 和 B 的签名。然后智能合约向 A 发送 a\* 个币，B 发送 b\* 个币，之后合约自动销毁。

此智能合约以及 A 和 B 用于更新池状态的网络协议是 A 和 B 之间的简单支付通道。根据 4.1.2 中描述的分类，它是一种混合服务：它的部分状态存在于区块链（智能合约）中，但其它大多数状态更新都是在链下（通过网络协议）执行的。 如果一切顺利，双方将能够按照自己的意愿执行尽可能多的交易（唯一的限制是通道的“容量”不会超支 - 即，他们在支付通道中的余额都是非负的）。所以，在链上就只需要两个交易：一个用于打开（创建）支付通道（智能合约），另一个用于关闭（销毁）它。


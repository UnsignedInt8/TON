# 4. TON 服务与应用

我们已经详细讨论了 TON 区块链和 TON 网络技术。 现在我们解释一些可以将它们组合在一起以创建各种服务和应用程序的方法，并讨论 TON 项目本身提供的一些服务。

## 4.1 TON 服务实现策略

我们首先讨论如何在 TON 生态系统内实现不同的区块链和网络相关的应用程序和服务。首先，按顺序进行简单分类：

### 4.1.1 应用与服务

我们把“应用（程序）”和“服务”这两个词视为可互换的。 但是，存在一种微妙且有些模糊的区别：应用通常直接向人类用户提供某些服务，而服务通常被其他应用程序和服务使用。 例如，TON Storage 是一项服务，因为它被设计为其它应用程序和服务存储文件，即使是人类用户也可以直接使用它。 如果通过 TON 网络提供的“区块链中的 Facebook”（参见2.9.13）或 Telegram Messenger，则更像是一个应用，即使某些“bot”可能在没有人为干预的情况下自动访问它。

### 4.1.2 应用的分类: 链上，链下或混合

为 TON 生态设计的服务或应用需要保留其数据并在何处对数据进行处理。 这导致以下应用（和服务）的分类：

1. 链上应用（参见 4.1.4）: 所有数据和处理都在 TON 区块链中。
2. 链下应用（参见 4.1.5）: 所有数据和处理都在 TON 区块链之外，只通过 TON 网络提供服务。
3. 混合应用（参见 4.1.7）: 部分（但不是全部）数据和处理在 TON 区块链中; 其余的通过 TON 网络提供的链下服务。

### 4.1.3 中心化和去中心化，以及分布式应用

另一个分类标准是应用（或服务）是依赖于中心化的服务器集群，还是真正“分布式”的（参见4.1.9）。 所有链上应用程序都是去中心化和分布式的。 离线和混合应用可能表现出不同程度的中心化。

现在让我们更详细地考虑上述可能性。

### 4.1.4 纯“链上”应用: 区块链中的分布式应用或“dApps”

4.1.2 中提到的一种可能的方法是在 TON 区块链中完全部署“分布式应用”（通常简称为“dApp”），其实质为智能合约或智能合约集合。 所有的数据将作为这些智能合约的永久状态的一部分保留，并且与项目的所有交互将通过发送到这些智能合约或从这些智能合约接收的消息来完成。

我们已经在 2.9.13 中讨论过这种方法的缺点和局限。 但它也有它的优点：这样的分布式应用程序不需要运行服务器或存储其数据（它在“区块链”中运行 - 即在验证人的硬件上运行），并享有区块链极高（拜占庭）的可靠性和可访问性。 这种分布式应用程序的开发人员不需要购买或租用任何硬件，她需要做的就是开发一些软件（即智能合约的代码）。 在那之后，她将有效地从验证人那里租用计算能力，并以 Grams 的形式支付费用（无论是她自己还是将这个费用放在用户的肩上）。

### 4.1.5 纯网络服务: “ton-sites”和“ton-services”

另一个极端的例子是在某些私有服务器上部署服务，并通过 3.1 中描述的 ADNL 协议将其提供给用户，当然也可以使用一些更高级别的协议，如 3.1.9 中讨论的 RLDP，可用于发送 RPC 查询，并以自定义格式提供服务。 通过这种方式，该服务将完全和区块链无关，只存在于 TON 网络中。

如 3.2.12 中所述，TON 区块链可能仅用于查找服务地址或抽象地址，但也能借助于诸如 TON DNS（参见4.3.1）之类的服务来翻译域名 - 将人类可读的字符串转换到抽象地址。

在某种程度上，ADNL 网络（即 TON 网络）类似于 Invisible Internet Project (I<sup>2</sup>P)，即所谓的“eep-services”（即用 I<sup>2</sup>P 地址作为其入口点，并通过 I<sup>2</sup>P 网络提供给客户端）。 我们认为驻留在 TON 网络中的这种纯粹的网络服务就是“TON 服务”。

“eep-service” 可以使用 HTTP 作为其客户端 - 服务器协议; 在 TON 网络环境中，“TON 服务”可能只使用 RLDP（参见3.1.9）来传输 HTTP 查询和响应。 如果它使用 TON DNS 将人类可读的域名转换为抽象地址，那么对网站类的服务就变得几乎完美了。 甚至可以编写一个专门的浏览器，或者在用户机器上运行特殊的代理（“ton-proxy”），从用户使用的普通 Web 浏览器接受任意 HTTP 查询，并通过 TON 网络将这些查询转发到服务的抽象地址。 然后，用户将具有类似于万维网（WWW）的浏览体验。

在 I<sup>2</sup>P 生态系统中，这种“eep-services”被称为“eep-sites”。 人们也可以在 TON 生态系统中轻松创建“ton-sites”。 得益于 TON DNS 等服务的存在，TON 区块链和 TON DHT 才能利用 TON DNS 将（TON）域名转换为抽象地址。

### 4.1.6 TON Messenger 作为一个 TON Service; 基于 RLDP 的 MTProto 

我们顺便提一下，[Telegram Messenger](https://telegram.org/) 用于客户端 - 服务器交互的 [MTProto 协议](https://core.telegram.org/mtproto)可以很容易地嵌入到 3.1.9 中讨论的 RLDP 协议中，从而有效地将 Telegram Messenger 转换为 TON 服务。 由于 TON 代理技术可以为 ton-sites 或 ton-service 的最终用户透明地使用，并且在 RLDP 和 ADNL 的更底层中实现（参见 3.1.6），这将使 Telegram Messenger 很难被封锁。 当然，其它消息和社交服务也可能从这项技术中受益。

### 4.1.7 混合服务：部分链下，部分链上

有些服务可能采用混合方法实现：大部分在链下处理，少部分在链上处理。 通过这种方式，部分状态仍将保留在 TON 区块链中，并且服务或用户的任何不当行为都可能受到智能合约的惩罚。

### 4.1.8 示例：链下保存文件 TON Storage

TON Storage 就是一个例子。 在最简单的形式中，它允许用户通过保存链上哈希来引用链下保存的文件，并且可能通过一个智能合约，在预先商定的时间内支付保存文件的费用。 实际上，文件可以被细分为一些小尺寸（例如，1千字节）的块，通过诸如Reed-Solomon 或 Fountain Code 为增加的块序列构造 Merkle 树哈希。 这个 Merkle 哈希树可以在智能合约中发布，而不是与文件的哈希一起发布。这有点让人联想到文件存储在 torrent 中的方式。

一种更简单的存储文件形式是完全链下的：仅为新文件创建一个“种子（torrent）”，并使用 TON DHT 作为此种子的“分布式种子跟踪器”（参见 3.2.10）。 对于流行的文件，这可能非常有效。但是，这并没有任何的可用性保证。 例如，对于一个假设的“区块链 Facebook”（参见 2.9.13），用户可能会选择将其用户的个人资料照片完全保存到“种子”中，这可能会丢失（不是特别受欢迎的）用户的照片 ，或有可能无法长时间呈现这些照片。 TON Storage 主要用于链下存储，但使用链上智能合约来保证文件的可用性可能是不错的选择。

### 4.1.9 去中心化的混合服务，或“雾服务”

到目前为止，我们已经讨论了中心化混合服务和应用。 虽然他们的链上组件位于区块链中以分布式的方式处理数据，但它们的链下组件依赖于服务提供商中心化控制的一些服务器。 所以我们可以从其中一家大公司提供的云计算服务中租用计算能力，而不是使用某些专用服务器。 但是，这不会使链下服务组件去中心化。

实现链下服务组件的去中心化在于创建一个这样的市场：任何拥有所需硬件并愿意租用其计算能力或磁盘空间的人都能向需要它们的人提供服务。

例如，可能存在一个注册机构（也可能称为“市场”或“交易所”），其中所有对其他用户需要存储文件感兴趣的节点都会发布它们的联系信息，以及它们的可用存储容量，可用性策略和价格。 需要这些服务的人可能会在那里查找，如果对方同意，则在区块链中创建智能合约并上传文件以进行链下存储。通过这种方式，像 TON Storage 这样的服务变得真正去中心化，因为它不需要依赖任何集中的服务器集群来存储文件。

### 4.1.10 示例：“雾计算”平台作为去中心化的混合服务

一个去中心化的混合应用的例子是，当想要执行某些特定计算（例如，3D 渲染或训练神经网络）时，通常需要特定且昂贵的硬件，而那些拥有这种设备的人可能通过类似的“交易所”提供他们的服务，以便那些需要这些服务的人租用他们，双方通过智能合约登记。这类似于“雾计算”平台，如 [Golem](https://golem.network/) 或 [SONM](https://sonm.io/)。

### 4.1.11 示例：TON Proxy 是一项雾服务

TON Proxy 提供了雾服务的另一个示例，其中希望提供其服务作为 ADNL 网络隧道的节点可能会自行注册信息，而需要的用户可能会根据价格、延迟和带宽选择其中一个节点。之后，可以使用由 TON Payments 提供的支付通道来处理那些代理服务的小额支付，例如，每 128 KiB 流量就收一次费用。

### 4.1.12 示例：TON Payments 是一项雾服务

TON Payments 平台也是这种去中心化混合应用的一个例子（参见下章）。

## 4.2 连接用户和服务提供商

我们在 4.1.9 中已经看到，“雾服务”（即去中心化混合服务）通常需要一些市场，交易所或注册管理机构，以供那些需要这些服务的人使用。

这些市场很可能被实现为中心化的、链上的，链下的或混合类的。

### 4.2.1 示例：连接到 TON Payments

例如，如果想要使用 TON Payments，第一步是找到“闪电网络”中的一些传输节点（参见 5.2），并与它们建立支付通道。 但是，目前尚不清楚这些节点是否愿意创建新的支付通道，因此，需要注册机构，其中记录了准备创建新链接的节点和布它们的联系信息（例如，它们的抽象地址）。

### 4.2.2 示例：将文件上传到 TON Storage

类似地，如果想要将文件上传到 TON Storage，她必须找到一些愿意签署智能合约的节点，以绑定文件的副本（或者任何低于特定大小限制的文件）。 因此，需要提供用于存储文件的服务节点的注册机构。

### 4.2.3 链上，混合和链下注册管理机构

这样的服务注册机构可以完全在链上实现，借助智能合约将注册表永久保留到区块链中。然而，这将是非常缓慢和昂贵的。所以混合方法更加有效，其中相对较小且更改较少的注册机构可以在连上提供服务（通过其抽象地址或其公钥，可用于定位实际的抽象地址，如 3.2.12），其余的使用中心化的链下服务。

最后，那些愿意提供服务的人，或那些想要购买服务的人，只需通过网络广播他们的服务信息，那么一个去中心化的纯链下应用就可能由公共重叠网络组成（参见 3.3）。如果要提供的服务非常简单，甚至可能不需要广播：重叠网络本身就可以视为用作提供特定服务的“注册机构”。 然后，需要此服务的客户端可能会查找此网络（参见 3.3.7）并查询此重叠网络的某些节点以使用服务。

### 4.2.4 侧链的注册机构或交易所

实现去中心化混合注册管理机构的另一种方法是创建一个独立的区块链（“侧链”），由其自己的一套验证人维护，并在链上通过智能合约发布验证人的身份信息，并通过专用重叠网络收集候选交易和广播块更新给相关方（参见 3.3）。然后，此侧链的任何全节点都可以维护自己的共享注册机构副本（基本上等于此侧链的全局状态），并处理与此注册机构相关的任意查询。

### 4.2.5 工作链中的注册机构或交易所

另一种选择是在 TON 区块链内创建专用工作链，专门用于创建注册机构，市场和交易所。 与基本工作链中的智能合约相比，这可能更有效，更便宜（参见 2.1.11）。但是，这仍然比在侧链中维护注册管理机构更昂贵（参见 4.2.4）。

## 4.3 访问 TON 服务

我们在 4.1 中讨论了可能用于创建 TON 生态系统中服务和应用的不同方法。 现在我们讨论如何访问这些服务，以及 TON 提供的一些“Helper Services”，包括 TON DNS 和 TON Storage。

### 4.3.1 TON DNS: 链上分层域名服务

TON DNS 是一种预定义服务，它使用一组智能合约来保存从人类可读域名到 ADNL 网络节点的（256 位）地址映射。

原则上虽然任何人都可以使用 TON 区块链来实现这样的服务，但是当应用程序或服务想要将人类可读标识符转换为地址时，默认情况下使用这种预定义服务是非常方便的。

### 4.3.2 TON DNS 用例

例如，希望将一些加密货币转移给另一个用户或商家的用户可能更愿意记住该用户或商家帐户的 TON DNS 域名，而不是将他们的 256 位帐户 ID 复制粘贴进他们的轻钱包客户端的收件人字段。

类似地，TON DNS 可用于定位智能合约的帐户 ID 或 TON 服务和 ton-sites 的入口点（参见 4.1.5），从而启用专用客户端（“TON 浏览器”）或通常的互联网浏览器 结合专门的 TON Proxy 扩展或独立应用程序，为用户提供类似 WWW 的浏览体验。

### 4.3.3 TON DNS 智能合约

TON DNS 通过特殊（DNS）智能合约树实现。 每个 DNS 智能合约都负责注册某些固定域的子域。TON DNS 系统的第一级域的 “root DNS” 智能合约被保存在主链中。 其帐户 ID 必须硬编码到希望直接访问 TON DNS 的所有软件中。

任何 DNS 智能合约都包含一个 Hashmap，将可变长度的以 null 结尾的 UTF-8 字符串映射到它们的“值”中。 此 Hashmap 是用二叉 Patricia 树实现的，类似于 2.3.7 中描述的，但这个 Hashmap 支持可变长字符串作为键。

### 4.3.4 DNS Hashmap 的值（TON DNS 记录）

这些值是由 TL-scheme 描述的“TON DNS 记录”（参见 2.2.5）。 它们由一组“魔数”组成，其中一个标明支持哪些特性，然后是一个帐户 ID 或智能 ID 又或是抽象网络地址（参见 3.1），又或是一个用于定位抽象地址服务的公钥（参见 3.2.12），又或重叠网络的描述，等等。 一个重要的用例是智能合约还用于解析其域的子域。通过这种方式，可以为不同的域创建单独的注册表，由这些域的所有者控制。

这些记录还可能包含到期时间，缓存时间（通常非常大，因为更新区块链中的值通常是昂贵的），并且在大多数是对相关子域所有者的引用。 所有者有权更改此记录（特别是所有者字段，从而将域名转移给其他人控制），并延长它的到期时间。

### 4.3.5 注册现有域的新子域

为了注册现有域的新子域，人们只需向智能合约发送包含要注册子域（键值要用预定义的格式）的消息。域名所有者确认子域名所有者身份，到期日期和所需费用。

子域名以“先到先得”的方式注册。

### 4.3.6 从 DNS 智能合约中检索数据

原则上，主链或分片链的任何全节点都可以查找 DNS 智能合约数据库中的任何子域。

但是，这种方法仅适用于某些 DNS 智能合约。如果使用非标准 DNS 智能合约，它将失败。

任何 DNS 智能合约都必须基于通用智能合约接口定义“已知函数签名”的“GET 方法”，然后通过该方法调用以查找键。 这种方法对其他智能合约也有意义，特别是那些链上和混合服务的合约，我们将在 4.3.11 中详细解释。

### 4.3.7 解析 TON DNS 域

一旦任何全节点可以查找任何 DNS 智能合约数据库中的条目，就可以从众所周知的根域开始，解析任意 TON DNS 域名到帐户 ID。

例如，如果想要解析 A.B.C，则在根域数据库中查找键 .C，.B.C 和 A.B.C。 如果找不到第一个，但第二个可以找到，并且其值是对另一个 DNS 智能合约的引用，则在目标智能合约的数据库中查找 A 并解析最终值。

### 4.3.8 为轻节点解析 TON DNS 域

通过这种方式，主链的全节点以及域解析过程中涉及的所有分片链可以在没有外部帮助的情况下将任何域名转换为其当前值。 轻节点可以请求全节点代表它执行此操作并返回该值以及 Merkle 证明（参见 2.5.11）。 这种 Merkle 证明将使得轻节点能够验证响应是否正确，因此与通常的 DNS 协议相比，这种 TON DNS 响应不能被恶意拦截器“欺骗”。

因为无法预计某个节点可以成为某个分片链的全节点，所以实际的 TON DNS 域解析将组合使用这两种策略。

### 4.3.9 专用的“TON DNS 服务器”

可以提供简单的 “TON DNS 服务器”，用于接收“DNS”查询（例如，通过3.1中描述的 ADNL 或 RLDP 协议），必要时向其它（全）节点转发一些子查询，并返回原始查询的响应，如果必要还需添加 Merkle 树进行验证。

这样的“DNS 服务器”可以使用 4.2 中描述的方法之一向任何其他节点，尤其是轻客户端提供其（免费或不免费）服务。 请注意，如果这些服务器被认为是 TON DNS 服务的一部分，它将从分布式纯链上服务变为分布式混合服务（即“雾化服务”）。

以上是对 TON DNS 服务的简要概述，TON DNS 服务是 TON 区块链和 TON 网络的可扩展链上人类可读域名注册机构。

### 4.3.10 访问智能合约中保存的数据

我们已经看到，有时需要访问存储在智能合约中的数据而不用改变其状态。

如果知道智能合约的实现细节，就可以从智能合约的持久性存储中提取所有需要的信息，这些信息可供智能合约所在的分片链的所有全节点使用。但是，这是一种非常不优雅的方式，因为这很大程度上取决于智能合约的具体实现。

### 4.3.11 智能合约的“Get 方法”

更好的方法是在智能合约中定义一些 Get 方法，即某些类型的入站消息不会影响智能合约的状态，但会生成一个或多个包含“结果”的输出消息。 以这种方式，仅知道它实现具有已知函数签名的 Get 方法，就可以从智能合约获得数据。

这是一种更加优雅，更符合面向对象编程（OOP）的方式。 但是，到目前为止它有一个明显的缺陷：必须将交易提交到区块链中（将获取消息发送到智能合约），等待它由验证人提交和处理，再从新块中提取答案，并且需要支付手续费（即，用于在验证人的硬件上执行 Get 方法）。 这实际上是在浪费资源： Get 方法不会改变智能合约的状态，因此不需要在区块链中执行。

### 4.3.12 试探性地执行智能合约 Get 方法

我们已经评论过（参见 2.4.6）任何全节点都可以从智能合约的给定状态开始，试探性执行任何智能合约的任何方法（即，向智能合约发送任何消息），而不实际提交相应的交易。全节点可以简单地将智能合约的代码加载到 TON VM 中，从分片链的全局状态初始化其持久存储，并用入站消息作为其输入参数执行智能合约代码，创建的输出消息将产生此计算的结果。

这样，任何全节点都可以评估任意智能合约的任意 Get 方法，前提是它们的函数签名（即入站和出站消息的格式）是已知的。 节点可以跟踪在该评估期间访问的分片状态的单元，并创建所执行计算的有效 Merkle 证明，以便向轻节点提供（参见2.5.11）。

### 4.3.13 TL-schemes 中的智能合约接口

回想一下，智能合约实现的方法（即它接受的输入消息）本质上是一些可以通过 TL-schemes 来描述（参见2.2.5）的 TL-serialized 对象。 得到的输出消息也可以用相同的 TL-schemes 描述。通过这种方式，智能合约提供给其他账户和智能合约的接口可以通过 TL-schemes 形式化。

特别是，智能合约支持的 Get 方法（的一部分）可以通过这种形式化的智能合约接口来描述。

### 4.3.14 智能合约的公共接口

请注意，形式化的智能合约接口，无论是 TL-schemes（表示为 TL 源文件;参见2.2.5）还是 TL-serialized 都可以通过多种形式发布 - 例如，在智能合约帐户描述的特殊字段中，存储在区块链中，或单独存储（如果此接口将被多次引用）。 在后一种情况下，支持的公共接口的哈希可以合并到智能合约描述中。

这种公共接口的一个例子是 DNS 智能合约，它应该至少实现一种用于查找子域的标准 Get 方法（参见 4.3.6）。 注册新子域的标准方法也可以包含在 DNS 智能合约的标准公共接口中。

### 4.3.15 智能合约的用户界面

智能合约公共接口的存在也有其它好处。 例如，钱包客户端应用程序可以在根据用户的请求时下载并检查这样智能合约的接口，然后显示智能合约支持的公共方法列表，也许还可能在正式界面中显示一些人类可读的注释。 在用户选择这些方法之一之后，可以根据 TL-schemes 自动生成表单，其中将提示用户所选方法所需的所有字段以及所需的加密货币量（例如，Grams）。 提交此表单将创建一个新的区块链交易，其中包含刚刚来自用户的区块链账户撰写的消息。

通过这种方式，只要这些智能合约发布了它们的接口，用户就可以通过填写和提交某些表单，以用户友好的方式与钱包客户端应用程序中的任意智能合约进行交互。

### 4.3.16 "ton-service"的用户界面

事实证明，“ton-service”（即驻留在 TON 网络中的服务以及通过 ADNL 和 RLDP 协议接受的查询; 参见 4.1.5）也可能从 TL-schemes 描述的公共接口中获益（ 参见 2.2.5）。客户端应用程序（例如轻钱包或“TON 浏览器”）可能会提示用户选择其中的一种方法，并使用用户有好的界面定义参数的填写表单，类似于刚刚在 4.3.15 中讨论的内容。 唯一的区别是生成的 TL-serialized 消息不作为区块链中的交易提交; 相反，它作为 RPC 查询被发送到“ton-service”的抽象地址，并且根据形式接口（即，TL-schemes）解析和显示对该查询的响应。

### 4.3.17 
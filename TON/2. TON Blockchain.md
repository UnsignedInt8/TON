# 2. TON Blockchain

我们将从叙述 TON 的核心组件 —— TON Blockchain 开始。叙述的方法是“自上而下”：我们首先给出整体的一般描述，然后提供每个组件的更多细节。

尽管原则上该区块链协议的若干个实例可以独立运行（例如，由于硬叉），为简单起见，我们在这里谈论 TON 区块链时只考虑其中一个。

## 2.1 TON Blockchain 是二维区块链

TON Blockchain 是区块链的集合（甚至是区块链集合的集合），因为没有一个单链区块链项目有能力满足百万级TPS的目标，而不是现在标准的每秒数十个交易。

### 2.1.1 区块链类型

该区块链是以下区块链的集合:

1. 主链(Masterchain): 包含协议和当前参数值的一般信息，认证者及其权益信息，工作链(Workchains)以及分片信息，以及最重要的最近工作链和分片链(Shardchains)的区块 Hash 集合。

2. 工作链(Working blockchains, Workchains): 作为“主力”的工作链最多有 2^32 个，它们包含了交易和只能合约。不同的工作链可能有不同的“规则”，这意味着它们拥有不同的账号地址格式、不同的交易格式、不同的智能合约虚拟机、不同的基础货币等等。然而，它们必须满足某些基本的互操作性标准，才能是不同的工作链之间的交互成为可能并且相对简单。在这方面，TON 区块链是异质(heterogeneous)的，类似于 EOS 和 PolkaDot 项目。

3. 分片链(Shardchains): 每一条工作链最多可以分成 2^60 个分片链。它们具有和工作链相同的规则和区块格式，但本身只负责一个账户子集。换句话说，系统中内置了一种分片形式。 因为所有这些分片链共享一个共同的块格式和规则，所以 TON 区块链在这方面是同质(homogeneous)的，类似于以太坊扩展提议中讨论的内容。

4. 在分片链中的每一个区块事实上并不是区块，而是一条链。通常块区块链或纵向区块链的区块里只包含一个块，然后我们会认为这对应分片链中的一个区块（这种情况下我们称之为“横向区块链”）。但是，如果需要修复不正确的分片链，则需要向纵向区块链中提交一个新的区块，这其中包含无效的横向区块链的块的替换，或者仅包含需要更改此块的先前版本的那些部分的描述。这是一种用于替换检测到的无效块的 TON 特定机制，而不会让分片链分叉，2.1.17将会对此有详细描述。现在，我们仅仅认为每个分片链不是传统的区块链，而将其认为是区块链的区块链或二维区块链。

### 2.1.2 无限分片范式

几乎全部的区块链的分片提议都是“自上而下”的: 首先想象有一条链，然后讨论如何将其拆分成几个交互的分片链，以提高性能并实现可扩展性。

TON 的分片方法是“自下而上”的，解释如下。

想象一下，将分片发挥到极致，那么每一条分片链中只保留一个账户或智能合约。这样我们就会有大量的“账户链”，每个账户链描述一个账户的状态和状态转换，并相互发送消息以传输价值和信息。

当然，拥有数亿条区块链是不切实际的，其中每个区块链通常很少出现更新（即新区块）。 为了更有效地实现它们，我们将这些“帐户链”分组为“分片链”，以便分片链的每个块本质上是已分配给此分片的帐户链块的集合。 因此，“帐户链”在“分片链”中仅具有纯粹的虚拟或逻辑存在。

我们将这种观点称为**无限分片范式**，它解释了 TON 区块链的许多设计决策。

### 2.1.3 消息、即时超立方路由

无限分片范式告诉我们将每个帐户（或智能合约）视为自己的分片链。 那么一个帐户可能影响另一个帐户状态的唯一方法就是向它发送一条消息（这是所谓的 Actor 模型的特殊实例，帐户为 Actors）。 因此，一个不同账户之间的消息系统（因为源账户和目标帐户通常位于不同的分片链中）对于可扩展系统（如TON区块链）至关重要。 实际上，TON 区块链的一个新功能，称为即时超立方路由，使其能够将在一个分片链块中创建的消息传递和处理到目标分片链的下一个块中，而不管系统中分片链的总数。

### 2.1.4 主链、工作链与分片链的数量

TON 区块链只包含一个主链。 但是，该系统最多可以容纳 2^32 个工作链，每个工作链最多可分为 2^60 个分片链。

### 2.1.5 工作链通常是虚拟的链，而不是真实的链

因为工作链通常被细分为分片链，所以工作链的存在是“虚拟的”，这意味着它不是真正的链，而是在下面2.2.1中描述的一般定义——只是一组分片链。 当只有一个分片链对应一个工作链时，这个独特的分片链可以认为是工作链，在这种情况下，工作链至少在一段时间内成为“真正的”区块链，从而获得与传统的单区块链设计的表面相似性。 然而，无限分片范式告诉我们，这种相似性确实是肤浅的: 潜在的大量“账户链”可以暂时归为一条区块链（分片链）仅仅只是一个巧合。

### 2.1.6 工作链的ID

每个工作链由其编号或由一个无符号的32位整数（workchain_id：uint32）标识。 工作链由主链中的特殊交易创建，该交易用于定义（以前未使用的）工作链标识符和工作链的正式描述，以使该工作链与其他工作链可交互以及可对该工作链的块进行验证。

### 2.1.7 工作链的创建与激活

只需准备好支付发布新工作链规范所需的（高）主链交易费用，基本上任何社区成员都可以创建新的工作链。 但是，为了激活新的工作链，需要三分之二的验证人共识，因为他们需要升级他们的软件来处理新工作链的块，并表示它们已经准备好通过特殊的主链交易使新的工作链生效。 对激活新工作链感兴趣的一方可能会通过智能合约分发的一些奖励来为验证人提供一些激励，以便支持新的工作链。

### 2.1.8 分片链的ID

每条分片链由一对元组 (w, s) = (workchain_id，shard_prefix) 标识，其中 workchain_id: uint32 标识相应的工作链，shard_prefix: 2^(0...60) 是一个长度最多为 60 的位串，定义了这个分片链负责的帐户子集。 即所有具有以 shard_prefix 开头的 account_id 的帐户（也就是说将 shard_prefix 作为最高有效位）将被分配给该分片链。

### 2.1.9 账户链的ID

回想一下，帐户链只是虚拟的存在。 但是，它们有一个自然的标识符 - 即 (workchain_id，account_id) - 因为任何帐户链都包含有关状态的信息和正好一个帐户（简单帐户或智能合约）的更新。

### 2.1.10 分片链的动态拆分与合并

一个不太复杂的系统可能使用静态分片。例如，通过使用 account_id 的前八位来选择 256 个预定义分片中的一个。

TON 区块链的一个重要特征是它实现了动态分片，这意味着分片数量是不固定的。相反，如果满足某些条件，则分片 (w，s) 可以自动细分为分片 (w，s.0) 和 (w，s.1)（比如很长一段时间内，原始分片上的交易负载足够高）。 相反，如果负载在一段时间内保持过低，则分片 (w，s.0) 和 (w，s.1) 可以自动合并回 shard (w，s) 。

因此，最初只为 工作链w 创建了一个分片 (w，∅)。 之后如果有必要，它会细分为更多的分片（参见2.7.6和2.7.8）。

### 2.1.11 基本工作链 (Basic Workchain/Workchain Zero)

虽然可以使用特定的规则和交易定义多达 2^32 个工作链，但我们最初只定义了一个工作链，其 workchain_id = 0。此工作链称为 Workchain Zero 或基本工作链，它用于处理 TON 智能合约和转移 TON 代币（也称为 **Gram**，参见附录A）。大多数应用程序可能只需要 Workchain Zero。 基本工作链的分片链将被称为 Basic Shardchains。

### 2.1.12 块生成时间

我们期望在每个分片链和主链中大约每五秒生成一个新块。 这是相当小的交易确认时间。 所有分片链的新块几乎同时生成，并且大约在分片链的新快生成一秒后又生成一个新的主链块，这是因为主链必须包含所有分片链的最新块的哈希值。

### 2.1.13 主链使工作链与分片链紧耦合

一旦分片链块的 Hash 被合并到主链的块中，那么该分片链块及其所有父块就被认为是“规范的”，这意味着它们可以被所有分片链的后续块中引用为固定不变的东西。 实际上，每个新的分片链块也包含最新主链块的 Hash，并且从该主链块引用的所有分片链块被更新的块视为不可变的。

本质上，这意味着在分片链块中提交的交易或消息可以安全地用在其它分片链的下一个块中，而不需要等待。（举个反例: 在大多数的“松散耦合”系统中，用户在转发消息或发送交易之前需要 20 个确认，例如EOS。）而 TON 这种在提交后仅仅五秒就能使用其它分片链中的交易和消息的能力就是我们认为的“紧密耦合”系统（这是同类产品中的第一个），这也是我们能够提供前所未有的性能的原因之一（参见2.8。 12和2.8.14）。

### 2.1.14 主链的块 Hash 也是全局状态

根据2.1.13，从外部观察者的角度来看，最后一个主链块的 Hash 就完全确定了系统的整体状态，所以不需要分别监视所有分片链的状态。

### 2.1.15 通过认证者生成新块

TON 区块链使用 Proof-of-Stake(PoS) 在分片链和主链中生成新块。 这意味着有一组特殊节点通过特殊的主链交易存入权益（大量 TON 代币），以便有资格进行新的块生成和验证。

然后，以确定性伪随机方式将较小的验证人子集分配给每个分片 (w，s)，并且大约每 1024 个块改变一次。 这个验证人子集通过从客户端收集合适的交易到新的有效候选块，并就下一个块的内容达成共识。 对于每个块，在验证人上存在伪随机选择的顺序，以确定哪个候选块具有最高的优先级。

验证人和其它节点检查候选块的有效性; 如果验证人签署了无效候选块，则可能会因此被惩罚一部分或全部的权益，或者在一段时间内不能验证区块的有效性。 在此之后，其它验证人应该对下一个区块的选择达成共识（主要是通过BFT（拜占庭容错;参见2.8.4）共识协议的有效变体，类似于 PBFT [4]或 Honey Badger BFT[11]）。 如果达成共识，则创建新块，并且验证人在它们之间划分交易费，以及一些系统奖励的代币。

每个验证人能够参与进多个不同验证人子集中。在这种情况下，全部的验证与共识都是并行计算的。

在所有的分片链的新块生成之后，或者生成区块超时，主链就会生成新的一个包括所有分片链的最新块哈希值的块。这是由所有验证人的 BFT 共识完成的。

有关 TON PoS 及其经济模型的更多详细信息，请参见第2.6节。


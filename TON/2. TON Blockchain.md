# 2. TON Blockchain

我们将从叙述 TON 的核心组件 —— TON Blockchain 开始。叙述的方法是“自上而下”：我们首先给出整体的一般描述，然后提供每个组件的更多细节。

尽管原则上该区块链协议的若干个实例可以独立运行（例如，由于硬叉），为简单起见，我们在这里谈论 TON 区块链时只考虑其中一个。

## 2.1 TON Blockchain 是二维区块链

TON Blockchain 是区块链的集合（甚至是区块链集合的集合），因为没有一个单链区块链项目有能力满足百万级TPS的目标，而不是现在标准的每秒数十个交易。

### 2.1.1 区块链类型

该区块链是以下区块链的集合:

1. 主链(Masterchain): 包含协议和当前参数值的一般信息，认证者及其权益信息，工作链(Workchains)以及分片信息，以及最重要的最近工作链和分片链(Shardchains)的区块 Hash 集合。

2. 工作链(Working blockchains, Workchains): 作为“主力”的工作链最多有 2^32 个，它们包含了交易和只能合约。不同的工作链可能有不同的“规则”，这意味着它们拥有不同的账号地址格式、不同的交易格式、不同的智能合约虚拟机、不同的基础货币等等。然而，它们必须满足某些基本的互操作性标准，才能是不同的工作链之间的交互成为可能并且相对简单。在这方面，TON 区块链是异质(heterogeneous)的，类似于 EOS 和 PolkaDot 项目。

3. 分片链(Shardchains): 每一条工作链最多可以分成 2^60 个分片链。它们具有和工作链相同的规则和区块格式，但本身只负责一个账户子集。换句话说，系统中内置了一种分片形式。 因为所有这些分片链共享一个共同的块格式和规则，所以 TON 区块链在这方面是同质(homogeneous)的，类似于以太坊扩展提议中讨论的内容。

4. 在分片链中的每一个区块事实上并不是区块，而是一条链。通常块区块链或纵向区块链的区块里只包含一个块，然后我们会认为这对应分片链中的一个区块（这种情况下我们称之为“横向区块链”）。但是，如果需要修复不正确的分片链，则需要向纵向区块链中提交一个新的区块，这其中包含无效的横向区块链的块的替换，或者仅包含需要更改此块的先前版本的那些部分的描述。这是一种用于替换检测到的无效块的 TON 特定机制，而不会让分片链分叉，2.1.17将会对此有详细描述。现在，我们仅仅认为每个分片链不是传统的区块链，而将其认为是区块链的区块链或二维区块链。

### 2.1.2 无限分片范式

几乎全部的区块链的分片提议都是“自上而下”的: 首先想象有一条链，然后讨论如何将其拆分成几个交互的分片链，以提高性能并实现可扩展性。

TON 的分片方法是“自下而上”的，解释如下。

想象一下，将分片发挥到极致，那么每一条分片链中只保留一个账户或智能合约。这样我们就会有大量的“账户链”，每个账户链描述一个账户的状态和状态转换，并相互发送消息以传输价值和信息。

当然，拥有数亿条区块链是不切实际的，其中每个区块链通常很少出现更新（即新区块）。 为了更有效地实现它们，我们将这些“帐户链”分组为“分片链”，以便分片链的每个块本质上是已分配给此分片的帐户链块的集合。 因此，“帐户链”在“分片链”中仅具有纯粹的虚拟或逻辑存在。

我们将这种观点称为**无限分片范式**，它解释了 TON 区块链的许多设计决策。

### 2.1.3 消息、即时超立方路由

无限分片范式告诉我们将每个帐户（或智能合约）视为自己的分片链。 那么一个帐户可能影响另一个帐户状态的唯一方法就是向它发送一条消息（这是所谓的 Actor 模型的特殊实例，帐户为 Actors）。 因此，一个不同账户之间的消息系统（因为源账户和目标帐户通常位于不同的分片链中）对于可扩展系统（如TON区块链）至关重要。 实际上，TON 区块链的一个新功能，称为即时超立方路由，使其能够将在一个分片链块中创建的消息传递和处理到目标分片链的下一个块中，而不管系统中分片链的总数。

### 2.1.4 主链、工作链与分片链的数量

TON 区块链只包含一个主链。 但是，该系统最多可以容纳 2^32 个工作链，每个工作链最多可分为 2^60 个分片链。

### 2.1.5 工作链通常是虚拟的链，而不是真实的链

因为工作链通常被细分为分片链，所以工作链的存在是“虚拟的”，这意味着它不是真正的链，而是在下面2.2.1中描述的一般定义——只是一组分片链。 当只有一个分片链对应一个工作链时，这个独特的分片链可以认为是工作链，在这种情况下，工作链至少在一段时间内成为“真正的”区块链，从而获得与传统的单区块链设计的表面相似性。 然而，无限分片范式告诉我们，这种相似性确实是肤浅的: 潜在的大量“账户链”可以暂时归为一条区块链（分片链）仅仅只是一个巧合。

### 2.1.6 工作链的ID

每个工作链由其编号或由一个无符号的32位整数（workchain_id：uint32）标识。 工作链由主链中的特殊交易创建，该交易用于定义（以前未使用的）工作链标识符和工作链的正式描述，以使该工作链与其他工作链可交互以及可对该工作链的块进行验证。

### 2.1.7 工作链的创建与激活

只需准备好支付发布新工作链规范所需的（高）主链交易费用，基本上任何社区成员都可以创建新的工作链。 但是，为了激活新的工作链，需要三分之二的验证人共识，因为他们需要升级他们的软件来处理新工作链的块，并表示它们已经准备好通过特殊的主链交易使新的工作链生效。 对激活新工作链感兴趣的一方可能会通过智能合约分发的一些奖励来为验证人提供一些激励，以便支持新的工作链。

### 2.1.8 分片链的ID

每条分片链由一对元组 (w, s) = (workchain_id，shard_prefix) 标识，其中 workchain_id: uint32 标识相应的工作链，shard_prefix: 2^(0...60) 是一个长度最多为 60 的位串，定义了这个分片链负责的帐户子集。 即所有具有以 shard_prefix 开头的 account_id 的帐户（也就是说将 shard_prefix 作为最高有效位）将被分配给该分片链。

### 2.1.9 账户链的ID

回想一下，帐户链只是虚拟的存在。 但是，它们有一个自然的标识符 - 即 (workchain_id，account_id) - 因为任何帐户链都包含有关状态的信息和正好一个帐户（简单帐户或智能合约）的更新。

### 2.1.10 分片链的动态拆分与合并

一个不太复杂的系统可能使用静态分片。例如，通过使用 account_id 的前八位来选择 256 个预定义分片中的一个。

TON 区块链的一个重要特征是它实现了动态分片，这意味着分片数量是不固定的。相反，如果满足某些条件，则分片 (w，s) 可以自动细分为分片 (w，s.0) 和 (w，s.1)（比如很长一段时间内，原始分片上的交易负载足够高）。 相反，如果负载在一段时间内保持过低，则分片 (w，s.0) 和 (w，s.1) 可以自动合并回 shard (w，s) 。

因此，最初只为 工作链w 创建了一个分片 (w，∅)。 之后如果有必要，它会细分为更多的分片（参见2.7.6和2.7.8）。

### 2.1.11 基本工作链 (Basic Workchain/Workchain Zero)

虽然可以使用特定的规则和交易定义多达 2^32 个工作链，但我们最初只定义了一个工作链，其 workchain_id = 0。此工作链称为 Workchain Zero 或基本工作链，它用于处理 TON 智能合约和转移 TON 代币（也称为 **Gram**，参见附录A）。大多数应用程序可能只需要 Workchain Zero。 基本工作链的分片链将被称为 Basic Shardchains。

### 2.1.12 块生成时间

我们期望在每个分片链和主链中大约每五秒生成一个新块。 这是相当小的交易确认时间。 所有分片链的新块几乎同时生成，并且大约在分片链的新快生成一秒后又生成一个新的主链块，这是因为主链必须包含所有分片链的最新块的哈希值。

### 2.1.13 主链使工作链与分片链紧耦合

一旦分片链块的 Hash 被合并到主链的块中，那么该分片链块及其所有父块就被认为是“规范的”，这意味着它们可以被所有分片链的后续块中引用为固定不变的东西。 实际上，每个新的分片链块也包含最新主链块的 Hash，并且从该主链块引用的所有分片链块被更新的块视为不可变的。

本质上，这意味着在分片链块中提交的交易或消息可以安全地用在其它分片链的下一个块中，而不需要等待。（举个反例: 在大多数的“松散耦合”系统中，用户在转发消息或发送交易之前需要 20 个确认，例如EOS。）而 TON 这种在提交后仅仅五秒就能使用其它分片链中的交易和消息的能力就是我们认为的“紧密耦合”系统（这是同类产品中的第一个），这也是我们能够提供前所未有的性能的原因之一（参见2.8。 12和2.8.14）。

### 2.1.14 主链的块 Hash 也是全局状态

根据2.1.13，从外部观察者的角度来看，最后一个主链块的 Hash 就完全确定了系统的整体状态，所以不需要分别监视所有分片链的状态。

### 2.1.15 通过认证者生成新块

TON 区块链使用 Proof-of-Stake(PoS) 在分片链和主链中生成新块。 这意味着有一组特殊节点通过特殊的主链交易存入权益（大量 TON 代币），以便有资格进行新的块生成和验证。

然后，以确定性伪随机方式将较小的验证人子集分配给每个分片 (w，s)，并且大约每 1024 个块改变一次。 这个验证人子集通过从客户端收集合适的交易到新的有效候选块，并就下一个块的内容达成共识。 对于每个块，在验证人上存在伪随机选择的顺序，以确定哪个候选块具有最高的优先级。

验证人和其它节点检查候选块的有效性; 如果验证人签署了无效候选块，则可能会因此被惩罚一部分或全部的权益，或者在一段时间内不能验证区块的有效性。 在此之后，其它验证人应该对下一个区块的选择达成共识（主要是通过BFT（拜占庭容错;参见2.8.4）共识协议的有效变体，类似于 PBFT [4]或 Honey Badger BFT[11]）。 如果达成共识，则创建新块，并且验证人在它们之间划分交易费，以及一些系统奖励的代币。

每个验证人能够参与进多个不同验证人子集中。在这种情况下，全部的验证与共识都是并行计算的。

在所有的分片链的新块生成之后，或者生成区块超时，主链就会生成新的一个包括所有分片链的最新块哈希值的块。这是由所有验证人的 BFT 共识完成的。

有关 TON PoS 及其经济模型的更多详细信息，请参见第2.6节。

### 2.1.16 主链的分叉

由紧耦合引起的复杂性是，在主链切换到不同的分支几乎必然需要在至少一些分片链中切换到另一个分支。 另一方面，只要主链中没有分叉，就不可能在分片链中分叉。

一般规则是，如果主链中的块 B' 是 B 的前身，B' 包含分片链(w, s) 的块 B'<sub>w, s</sub> 的 HASH(B'<sub>w,s</sub>)，并且 B 包含了 HASH(B<sub>w, s</sub>)，那么 B'<sub>w, s</sub> 一定是 B<sub>w, s</sub> 的前身，否则主链块中的 B 是无效的。

我们预计主链轮叉是罕见的，甚至是不存在的。因为在 TON 区块链采用的 BFT 范例中，只有在大多数验人行为不正确（这将意味着违法者将遭受重大的权益损失）的情况下才能发生这种情况（参见2.6.1和2.6.15）。 因此，预计分片链中也没有真正的分叉。 相反，如果检测到无效的分片链块，它将通过二维区块链的“纵向区块链”机制（参见2.1.17）进行纠正，而不会分叉“横向区块链”（即分片链）。 同样的机制也可用于修复主链块中的非致命错误。

### 2.1.17 更正无效的分片链块

通常，在分片链中必须达到三分之二验证人达成拜占庭共识才能提交新块。 但是，系统必须检测先前提交的无效块以及对其更正。

当然，一旦由由验证人或“渔夫”（系统的任何节点进行了某种存款，而提出有关区块有效性的问题）找到无效的分片块，签署无效区块的验证人将因此失去部分权益和/或被禁职（后一种措施对于攻击者窃取其他良性验证人的签名密钥的情况很重要）。

但这还不够，因为系统的整体状态由于先前提交的分片块无效而证明是无效的。必须使用较新的有效版本替换此无效块。

大多数系统都会通过“回滚”到此分片链中的无效块之前的最后一个块并且该块不受从其他每个分片链中传播无效块的消息的影响，并从这些块创建新的分叉来实现此目的。 这种方法的缺点是大量的其他正确的和提交的交易突然回滚，并且不清楚它们是否稍后还能被有效确认。

TON 区块链通过使每个分片链和主链（横向区块链）的每个“块”自身成为一个小区块链（纵向区块链）来解决这个问题，这个纵向区块链包含不同版本的“块”或它们的“差异”。 通常，纵向区块链只包含一个区块，而分片链则看起来像一个经典的区块链。 然而，一旦确认块的无效性并在主链块中得到确认，则在纵向上允许在该无效块被新块替换以纠正该无效块。 新块由相关分片链的当前验证人子集生成。

新“纵向”块的有效规则非常严格。特别是，如果无效块中包含有效的虚拟“帐户链块”（参见2.1.2），则必须由新的块更正且保持账户链不变。

一旦在无效块之上提交了新的“纵向”块，其哈希就会发布在新的主链块中（或者更确切地说是在新的“纵向”块中，位于包含最初发布的无效分片块HASH的主链块上方），并且引用了该无效快的所有分片快都会更正。这是通过在纵向区块链中为以前引用“不正确”区块的所有区块提交新的“纵向”区块来解决的; 新的纵向块将引用最新（已更正）的版本。 同样，也禁止更改未受影响的帐户链（即，接收与先前版本相同的消息）。 通过这种方式，修复不正确的块会产生“涟漪”，最终传播到所有受影响的分片链的最新块; 这些变化也反映在新的“纵向”主链块中。

一旦该“涟漪”到达最新的块，新的分片块就作为最新块版本的后继者生成。这意味着它们将从一开始就包含对正确纵向块的引用。

主链状态隐含地定义了将每个“纵向”区块链的第一个块的 HASH 转换为其最新版本的 HASH 的映射。 这使客户端能够通过其第一个（通常是唯一的）块的 HASH 来识别和定位任何纵向区块链。

### 2.1.18 TON 代币与多币工作链

TON 区块链支持多达 2^32 种不同的“加密货币”，由 32 位 currency_id 区分。可通过主链中的特殊交易添加新的加密货币。 每个工作链都有一个基本的加密货币，并且可以有多个额外币种。

有一种特殊的加密货币，currency_id = 0，即 TON 币，也称为 **Gram**（参见附录A）。 它是Workchain Zero 的基本加密货币。它也用于充当手续费和验证人的权益收入。

原则上，其他工作链可能会收取其它代币的交易费用。在这种情况下，应提供一些智能合约，将这些交易费自动转换为 Grams。

### 2.1.19 消息与价值转移

属于相同或不同工作链的分片链可以相互发送消息。 虽然消息的确切形式取决于接收工作链和接收帐户（智能合约），但有一些共同的字段使得工作链之间的消息传递成为可能。 特别地，只要它们被接收工作链声明为可接受的加密货币，那么每个消息可以以一定量的 Gram 和/或其他注册的加密货币的形式附带一些价值。

消息传递的最简单形式是从一个（通常不是智能合约）账户到另一个账户的价值转移。

### 2.1.20 TON 虚拟机

TON虚拟机（也称为 TON VM或 TVM）是用于在主链和基本工作链中执行智能合约代码的虚拟机。 其它工作链可以与 TVM 一起使用别的 TVM。

在这里，我们列出了它的一些功能。 它们将在 2.3.12, 2.3.14 和其它地方进一步讨论。

1. TVM 将所有数据表示为 TVM 单元(cell)的集合（参见2.3.14）。每个单元最多包含 128 个数据字节，4 个对其它单元的引用。 由于“一切都是单元”的理念（参见2.5.14），这使 TVM 能够处理与 TON 区块链相关的所有数据，包括块和区块链全局状态（如有必要）。

2. TVM 可以处理任意代数数据类型的值（2.3.12），其表示为 TVM 单元的树或有向无环图。但是，它并不关心数据类型; 数据类型只适用于单元。

3. TVM 内置了对哈希表(Hashmaps)的支持。

4. TVM 是基于栈的虚拟机。 它的堆栈保持64位整数或单元格引用。

5. 支持 64 位，128 位和 256 位算术。 所有 n 位算术运算有三种形式：无符号整数，有符号整数和 2^n 整数模（后一种情况下不进行自动溢出检查）。

6. TVM 具有从 n 位到 m 位的无符号和有符号整数转换，对于所有 0 ≤ m，n ≤ 256，具有溢出检查。

7. 默认情况下，所有算术运算都执行溢出检查，大大简化了智能合约的开发。

8. TVM 具有 "multiply-then-shift" 和 “shift-then-divide” 算术运算，其中间值以大整数类型计算; 这简化了算术的过程。

9. TVM 支持位串和字符串。

10. 支持预定义的 256 位椭圆曲线加密（ECC），包括Curve25519。

11. 还存在对一些椭圆曲线上的 Weil Pairings 的支持，这对于快速实现zk-SNARK是有用的。

12. 支持流行的哈希函数，包括 SHA256。

13. TVM 支持 Merkle Proofs（参见5.1.9）。

14. TVM 支持“大型”智能合约或“全局”智能合约，而这种智能合约必须要有分片的意识（参见2.3.18和2.3.16）。 通常（本地）智能合约可以是无需考虑分片的。

15. TVM 支持闭包。

16. 可以在TVM内轻松实现“spineless tagless G-machine”。

除了“TVM 汇编语言”之外，还可以为 TVM 设计几种高级语言。 所有这些语言都将具有静态类型，并将支持代数数据类型。 我们设想了以下可能性：

1. 一种类似Java的命令式语言，每个智能合约类似于一个单独的类。

2. 一种惰性函数式语言（类似 Haskell）。

3. 一种快速的函数式语言（类似 ML）。

### 2.1.21 可配置参数

TON 区块链的一个重要特征是它的许多参数都是可配置的。 这意味着它们是主链状态的一部分，并且可以通过主链中的某些特殊提议/投票/结果交易进行更改，而无需任何硬叉。 改变这些参数将需要三分之二的验证人投票和所有其它支持该修改提议的一半以上参与者投票。

## 2.2 TON 区块链的一般概括

### 2.2.1 区块链的一般定义

通常，区块链是一系列首尾相连的块，每个块 B 包含前一个块(blk-prev [B])的引用 （通常通过将前一个块的 HASH 包含在当前块的头部中），以及交易清单。 每个交易描述了全局区块链状态的一些转换; 按顺序将块中的每个交易以某个算法计算，即可获得该块的最新状态。

### 2.2.2 TON 区块链的相关性

回想一下，TON Blockchain 不是传统意义的区块链，而是二维区块链的集合（即区块链的区块链;参见2.1.1），因此上述内容并不直接适用于 TON Blockchain。 但是，我们从传统区块链的这些一般性开始，将其用于构造更复杂结构的系统。

### 2.2.3 区块链实例和区块链类型

人们经常使用区块链这个词来表示一般的区块链类型及其特定的区块链实例。 例如，2.2.1 指的区块链实例。

